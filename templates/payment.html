<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CoinVibe Pay - Complete Payment</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .pulse { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: .5 } 50% { opacity: 1 } 100% { opacity: .5 } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <nav class="bg-white shadow">
    <div class="max-w-3xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center">
        <div class="w-9 h-9 gradient-bg rounded-lg flex items-center justify-center">
          <span class="text-white font-bold">â‚µV</span>
        </div>
        <span class="ml-3 font-semibold text-gray-900">CoinVibe Pay</span>
      </div>
      <a href="./index.html" class="text-sm text-gray-600 hover:text-gray-900">Merchant Portal</a>
    </div>
  </nav>

  <main class="max-w-3xl mx-auto px-4 py-8">
    <div id="card" class="bg-white rounded-2xl shadow p-6">
      <h1 class="text-2xl font-bold mb-6">Complete Your Payment</h1>

      <div id="loading" class="flex items-center space-x-3 text-gray-600">
        <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
        <span>Fetching payment details...</span>
      </div>

      <div id="content" class="hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <p class="text-sm text-gray-600 mb-1">Payment ID</p>
              <p id="pid" class="font-mono text-sm break-all"></p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg mt-4">
              <p class="text-sm text-gray-600 mb-1">Amount to Send</p>
              <p class="text-lg"><span id="amount" class="font-semibold"></span> <span id="symbol">USDT</span></p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg mt-4">
              <div class="flex items-center justify-between mb-1">
                <p class="text-sm text-gray-600">Wallet Address</p>
                <button id="copyAddressBtn" class="text-xs text-purple-600 hover:underline">Copy</button>
              </div>
              <p id="address" class="font-mono text-sm break-all"></p>
            </div>
            <div class="mt-4">
              <span id="statusPill" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">pending</span>
            </div>
          </div>
          <div class="text-center">
            <img id="qr" class="mx-auto rounded-lg shadow" alt="QR Code" />
            <p class="text-sm text-gray-600 mt-3">Scan the QR or copy the address to send payment.</p>
          </div>
        </div>

        <div id="tips" class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
          <p>Ensure you send exactly the amount shown on the specified network to avoid delays.</p>
        </div>

        <div id="doneMsg" class="hidden mt-6 bg-green-50 border border-green-200 text-green-800 rounded-lg p-4">
          Payment detected and confirmed. Thank you!
        </div>

        <div id="errorMsg" class="hidden mt-6 bg-red-50 border border-red-200 text-red-800 rounded-lg p-4">
          Payment failed or expired. Please contact the merchant if you already sent funds.
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_URL = 'http://localhost:8000/api';
    const pid = new URLSearchParams(location.search).get('pid');
    const els = {
      loading: document.getElementById('loading'),
      content: document.getElementById('content'),
      pid: document.getElementById('pid'),
      amount: document.getElementById('amount'),
      symbol: document.getElementById('symbol'),
      address: document.getElementById('address'),
      qr: document.getElementById('qr'),
      statusPill: document.getElementById('statusPill'),
      doneMsg: document.getElementById('doneMsg'),
      errorMsg: document.getElementById('errorMsg'),
      copyAddressBtn: document.getElementById('copyAddressBtn'),
    };

    if (!pid) {
      document.getElementById('card').innerHTML = `
        <div class="p-6 text-center">
          <p class="text-red-600">Missing payment id. Please use the link provided by the merchant.</p>
          <a class="inline-block mt-4 text-purple-600 hover:underline" href="./index.html">Go back</a>
        </div>`;
    } else {
      init();
    }

    async function init() {
      els.copyAddressBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(els.address.textContent);
          els.copyAddressBtn.textContent = 'Copied!';
          setTimeout(() => els.copyAddressBtn.textContent = 'Copy', 1500);
        } catch {}
      });

      await loadPayment();
      startPolling();
    }

    async function loadPayment() {
      try {
        const res = await fetch(`${API_URL}/payments/${pid}`);
        const data = await res.json();
        if (!data.success || !data.payment) throw new Error('Payment not found');

        const p = data.payment;
        els.pid.textContent = p.payment_id;
        els.amount.textContent = p.crypto_amount;
        els.address.textContent = p.wallet_address;
        els.qr.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${p.wallet_address}`;
        setStatus(p.status);

        els.loading.classList.add('hidden');
        els.content.classList.remove('hidden');
      } catch (e) {
        els.loading.innerHTML = `<span class="text-red-600">${e.message}</span>`;
      }
    }

    function setStatus(status) {
      const map = {
        pending: ['bg-yellow-100 text-yellow-800', 'Pending - awaiting payment'],
        detected: ['bg-blue-100 text-blue-800', 'Detected - awaiting confirmations'],
        confirmed: ['bg-indigo-100 text-indigo-800', 'Confirmed - processing payout'],
        processing: ['bg-indigo-100 text-indigo-800', 'Processing payout'],
        completed: ['bg-green-100 text-green-800', 'Completed'],
        failed: ['bg-red-100 text-red-800', 'Failed'],
      };
      const [cls, label] = map[status] || ['bg-gray-100 text-gray-800', status];
      els.statusPill.className = `inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${cls}`;
      els.statusPill.textContent = label.toLowerCase();

      // Success/failure banners
      if (status === 'completed') {
        els.doneMsg.classList.remove('hidden');
        els.errorMsg.classList.add('hidden');
      } else if (status === 'failed') {
        els.errorMsg.classList.remove('hidden');
        els.doneMsg.classList.add('hidden');
      } else {
        els.doneMsg.classList.add('hidden');
        els.errorMsg.classList.add('hidden');
      }
    }

    function startPolling() {
      let attempts = 0;
      const interval = setInterval(async () => {
        attempts += 1;
        try {
          const res = await fetch(`${API_URL}/payments/${pid}`);
          const data = await res.json();
          if (data && data.success && data.payment) {
            setStatus(data.payment.status);
            if (['completed', 'failed'].includes(data.payment.status)) {
              clearInterval(interval);
            }
          }
        } catch {}
        if (attempts > 120) clearInterval(interval); // Stop after ~20 min (10s * 120)
      }, 10000);
    }
  </script>
</body>
</html>
