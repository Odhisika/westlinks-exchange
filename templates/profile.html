{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile Settings â€¢ CoinVibe Pay</title>
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</head>

<body>
  <!-- Authentication Check -->
  <script>
    (function () {
      const token = localStorage.getItem('coinvibe_token');
      if (!token || token === 'null' || token === 'undefined' || token === '') {
        window.location.href = '/login?next=/profile';
      }
    })();
  </script>
  <header class="cvp-header">
    <div class="cvp-header-inner">
      <a href="/dashboard" class="cvp-brand">
        <div class="cvp-brand-logo">CV</div>
        <span>CoinVibe Pay</span>
      </a>

      <!-- Mobile Hamburger Menu Button -->
      <button class="mobile-nav-toggle" onclick="toggleSidebar()" aria-label="Toggle navigation">
        <i data-lucide="menu" style="width: 24px; height: 24px;"></i>
      </button>
      <nav class="cvp-nav">
        <a href="/dashboard" class="cvp-link">Dashboard</a>
        <a href="/profile" class="cvp-link">Profile</a>
        <div id="dashUserMenu" style="display:flex; align-items:center; gap:.5rem; margin-left:1rem;">
          <div id="dashAvatar"
            style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg, var(--highlight-yellow), var(--highlight-cyan));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.875rem;">
            U</div>
          <span id="dashUserName" class="text-primary" style="font-weight:600;"></span>
          <button onclick="logout()" class="cvp-link"
            style="color:#ef4444; background:none; border:none; cursor:pointer;">Logout</button>
        </div>
      </nav>
    </div>
  </header>

  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="dashboard-sidebar" id="dashboardSidebar">
      <nav class="sidebar-nav">
        <div class="sidebar-section">
          <div class="sidebar-section-title">Main Menu</div>
          <a href="/dashboard" class="sidebar-link">
            <i data-lucide="layout-dashboard"></i>
            <span>Overview</span>
          </a>
          <a href="/buy" class="sidebar-link">
            <i data-lucide="link"></i>
            <span>Payment Links</span>
          </a>
          <a href="/sell" class="sidebar-link">
            <i data-lucide="coins"></i>
            <span>Sell Crypto</span>
          </a>
          <a href="#" class="sidebar-link">
            <i data-lucide="receipt"></i>
            <span>Transactions</span>
          </a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <a href="/profile" class="sidebar-link active">
            <i data-lucide="user"></i>
            <span>Profile</span>
          </a>
          <a href="#" class="sidebar-link">
            <i data-lucide="refresh-cw"></i>
            <span>Refresh Rates</span>
          </a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Account</div>
          <a href="#" class="sidebar-link" onclick="logout(); return false;">
            <i data-lucide="log-out"></i>
            <span>Logout</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="dashboard-main">
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-avatar-large" id="profileAvatarLarge">
          U
          <div class="profile-avatar-edit" onclick="alert('Avatar upload coming soon!')">
            <i data-lucide="camera" style="width: 18px; height: 18px;"></i>
          </div>
        </div>
        <div class="profile-info">
          <h1 class="profile-name" id="profileName">User Name</h1>
          <p class="profile-email" id="profileEmail">user@example.com</p>
          <div class="profile-badges">
            <span class="badge badge-success">
              <i data-lucide="check-circle" style="width: 12px; height: 12px; margin-right: 4px;"></i>
              Verified
            </span>
            <span class="badge badge-info">
              <i data-lucide="shield" style="width: 12px; height: 12px; margin-right: 4px;"></i>
              Vendor
            </span>
          </div>
        </div>
      </div>

      <!-- Personal Information -->
      <div class="settings-section">
        <h2 class="settings-section-title">Personal Information</h2>
        <form id="personalInfoForm" onsubmit="updatePersonalInfo(event)">
          <div class="settings-form-row">
            <div class="settings-form-group">
              <label for="fullName">Full Name</label>
              <input type="text" id="fullName" class="field" placeholder="Enter your full name" required />
            </div>
            <div class="settings-form-group">
              <label for="username">Username</label>
              <input type="text" id="username" class="field" placeholder="Enter username" required />
            </div>
          </div>

          <div class="settings-form-row">
            <div class="settings-form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" class="field" placeholder="your@email.com" required readonly
                style="background: var(--bg-secondary); cursor: not-allowed;" />
              <p class="text-muted" style="font-size: 0.75rem; margin-top: 0.25rem;">Email cannot be changed</p>
            </div>
            <div class="settings-form-group">
              <label for="phone">Phone Number</label>
              <input type="tel" id="phone" class="field" placeholder="+233 24 123 4567" />
            </div>
          </div>

          <div class="settings-form-group">
            <label for="bio">Bio (Optional)</label>
            <textarea id="bio" class="field" rows="3" placeholder="Tell us about yourself..."></textarea>
          </div>

          <div style="display: flex; gap: var(--spacing-sm); justify-content: flex-end;">
            <button type="button" onclick="resetPersonalInfo()" class="btn btn-secondary">
              <i data-lucide="x" style="width: 18px; height: 18px;"></i>
              Reset
            </button>
            <button type="submit" class="btn btn-primary">
              <i data-lucide="save" style="width: 18px; height: 18px;"></i>
              Save Changes
            </button>
          </div>
        </form>
      </div>

      <!-- Payment Settings -->
      <div class="settings-section">
        <h2 class="settings-section-title">Payment Settings</h2>
        <form id="paymentSettingsForm" onsubmit="updatePaymentSettings(event)">
          <div class="settings-form-row">
            <div class="settings-form-group">
              <label for="momoNumber">Mobile Money Number</label>
              <input type="tel" id="momoNumber" class="field" placeholder="0244123456" pattern="0\d{9}" />
              <p class="text-muted" style="font-size: 0.75rem; margin-top: 0.25rem;">10 digits starting with 0</p>
            </div>
            <div class="settings-form-group">
              <label for="momoProvider">MoMo Provider</label>
              <select id="momoProvider" class="field">
                <option value="">Select Provider</option>
                <option value="MTN">MTN Mobile Money</option>
                <option value="Vodafone">Vodafone Cash</option>
                <option value="AirtelTigo">AirtelTigo Money</option>
              </select>
            </div>
          </div>

          <div class="settings-form-group">
            <label for="walletAddress">USDT Wallet Address (Optional)</label>
            <input type="text" id="walletAddress" class="field" placeholder="Your TRC20/ERC20 wallet address" />
            <p class="text-muted" style="font-size: 0.75rem; margin-top: 0.25rem;">Your personal wallet for receiving
              payments</p>
          </div>

          <div style="display: flex; gap: var(--spacing-sm); justify-content: flex-end;">
            <button type="button" onclick="resetPaymentSettings()" class="btn btn-secondary">
              <i data-lucide="x" style="width: 18px; height: 18px;"></i>
              Reset
            </button>
            <button type="submit" class="btn btn-primary">
              <i data-lucide="save" style="width: 18px; height: 18px;"></i>
              Save Changes
            </button>
          </div>
        </form>
      </div>

      <!-- Security Settings -->
      <div class="settings-section">
        <h2 class="settings-section-title">Security Settings</h2>
        <form id="securityForm" onsubmit="updatePassword(event)">
          <div class="settings-form-group">
            <label for="currentPassword">Current Password</label>
            <input type="password" id="currentPassword" class="field" placeholder="Enter current password" />
          </div>

          <div class="settings-form-row">
            <div class="settings-form-group">
              <label for="newPassword">New Password</label>
              <input type="password" id="newPassword" class="field" placeholder="Enter new password" minlength="8" />
              <p class="text-muted" style="font-size: 0.75rem; margin-top: 0.25rem;">Minimum 8 characters</p>
            </div>
            <div class="settings-form-group">
              <label for="confirmPassword">Confirm New Password</label>
              <input type="password" id="confirmPassword" class="field" placeholder="Confirm new password"
                minlength="8" />
            </div>
          </div>

          <div style="display: flex; gap: var(--spacing-sm); justify-content: flex-end;">
            <button type="button" onclick="resetSecurityForm()" class="btn btn-secondary">
              <i data-lucide="x" style="width: 18px; height: 18px;"></i>
              Reset
            </button>
            <button type="submit" class="btn btn-primary">
              <i data-lucide="lock" style="width: 18px; height: 18px;"></i>
              Update Password
            </button>
          </div>
        </form>
      </div>

      <!-- Notification Preferences -->
      <div class="settings-section">
        <h2 class="settings-section-title">Notification Preferences</h2>
        <form id="notificationForm" onsubmit="updateNotifications(event)">
          <div class="settings-form-group">
            <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
              <input type="checkbox" id="emailNotifications" checked
                style="width: 20px; height: 20px; cursor: pointer;" />
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Email Notifications</div>
                <div class="text-muted" style="font-size: 0.75rem;">Receive email updates about your transactions</div>
              </div>
            </label>
          </div>

          <div class="settings-form-group">
            <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
              <input type="checkbox" id="paymentAlerts" checked style="width: 20px; height: 20px; cursor: pointer;" />
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Payment Alerts</div>
                <div class="text-muted" style="font-size: 0.75rem;">Get notified when you receive payments</div>
              </div>
            </label>
          </div>

          <div class="settings-form-group">
            <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
              <input type="checkbox" id="marketingEmails" style="width: 20px; height: 20px; cursor: pointer;" />
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Marketing Emails</div>
                <div class="text-muted" style="font-size: 0.75rem;">Receive updates about new features and promotions
                </div>
              </div>
            </label>
          </div>

          <div style="display: flex; gap: var(--spacing-sm); justify-content: flex-end; margin-top: var(--spacing-md);">
            <button type="submit" class="btn btn-primary">
              <i data-lucide="save" style="width: 18px; height: 18px;"></i>
              Save Preferences
            </button>
          </div>
        </form>
      </div>

      <!-- Danger Zone -->
      <div class="settings-section" style="border-color: rgba(239, 68, 68, 0.3);">
        <h2 class="settings-section-title" style="color: #ef4444;">Danger Zone</h2>
        <div
          style="padding: var(--spacing-md); background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px;">
          <div
            style="display: flex; justify-content: space-between; align-items: center; gap: var(--spacing-md); flex-wrap: wrap;">
            <div>
              <h4 style="color: #ef4444; margin-bottom: 0.5rem; font-size: var(--font-size-base); font-weight: 600;">
                Delete Account</h4>
              <p class="text-muted" style="font-size: 0.875rem; margin: 0;">Permanently delete your account and all
                associated data. This action cannot be undone.</p>
            </div>
            <button onclick="confirmDeleteAccount()" class="btn"
              style="background: #ef4444; color: white; flex-shrink: 0;">
              <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
              Delete Account
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Sidebar Toggle -->
  <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
    <i data-lucide="menu" style="width: 24px; height: 24px;"></i>
  </button>

  <!-- Success Toast -->
  <div id="successToast"
    style="display: none; position: fixed; bottom: var(--spacing-lg); right: var(--spacing-lg); background: var(--bg-card); border: 1px solid var(--highlight-green); border-radius: 12px; padding: var(--spacing-md); box-shadow: var(--shadow-lg), var(--glow-green); z-index: 2000; min-width: 300px;">
    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
      <i data-lucide="check-circle" style="width: 24px; height: 24px; color: var(--highlight-green);"></i>
      <div>
        <div style="font-weight: 600; color: var(--text-primary);">Success!</div>
        <div class="text-secondary" style="font-size: 0.875rem;" id="successMessage">Changes saved successfully</div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin + '/api';
    const tokenRaw = localStorage.getItem('coinvibe_token');
    let currentUser = null;
    try { currentUser = JSON.parse(localStorage.getItem('coinvibe_user') || 'null'); } catch (_) { currentUser = null; }
    const authToken = tokenRaw && tokenRaw !== 'null' && tokenRaw !== 'undefined' && tokenRaw !== '' ? tokenRaw : null;

    if (!authToken || !currentUser) {
      window.location.href = '/login';
    }

    function initHeader() {
      const name = currentUser && (currentUser.name || currentUser.username || currentUser.full_name) ? (currentUser.name || currentUser.username || currentUser.full_name) : '';
      document.getElementById('dashUserName').textContent = name;
      document.getElementById('dashAvatar').textContent = name ? name.charAt(0).toUpperCase() : 'U';
    }

    function logout() {
      localStorage.removeItem('coinvibe_token');
      localStorage.removeItem('coinvibe_user');
      window.location.href = '/';
    }

    function toggleSidebar() {
      document.getElementById('dashboardSidebar').classList.toggle('active');
    }

    function showToast(message) {
      document.getElementById('successMessage').textContent = message;
      const toast = document.getElementById('successToast');
      toast.style.display = 'block';
      if (window.lucide && lucide.createIcons) lucide.createIcons();
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    function loadUserProfile() {
      // Populate profile data
      const name = currentUser.name || currentUser.username || currentUser.full_name || 'User';
      const email = currentUser.email || 'user@example.com';

      document.getElementById('profileName').textContent = name;
      document.getElementById('profileEmail').textContent = email;
      document.getElementById('profileAvatarLarge').textContent = name.charAt(0).toUpperCase();

      // Personal Info
      document.getElementById('fullName').value = currentUser.full_name || currentUser.name || '';
      document.getElementById('username').value = currentUser.username || '';
      document.getElementById('email').value = email;
      document.getElementById('phone').value = currentUser.phone || '';
      document.getElementById('bio').value = currentUser.bio || '';

      // Payment Settings
      document.getElementById('momoNumber').value = currentUser.momo_number || '';
      document.getElementById('momoProvider').value = currentUser.momo_provider || '';
      document.getElementById('walletAddress').value = currentUser.wallet_address || '';
    }

    async function updatePersonalInfo(event) {
      event.preventDefault();
      const data = {
        full_name: document.getElementById('fullName').value,
        username: document.getElementById('username').value,
        phone: document.getElementById('phone').value,
        bio: document.getElementById('bio').value
      };

      try {
        const res = await fetch(`${API_URL}/users/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        if (result.success) {
          // Update local storage
          currentUser = { ...currentUser, ...data, name: data.full_name };
          localStorage.setItem('coinvibe_user', JSON.stringify(currentUser));
          showToast('Personal information updated successfully!');
          initHeader();
          loadUserProfile();
        } else {
          alert(result.message || 'Failed to update profile');
        }
      } catch (e) {
        console.error('Update failed:', e);
        showToast('Profile updated locally');
      }
    }

    async function updatePaymentSettings(event) {
      event.preventDefault();
      const momoNumber = document.getElementById('momoNumber').value;

      if (momoNumber && !/^0\d{9}$/.test(momoNumber)) {
        alert('Please enter a valid Ghana mobile money number (10 digits starting with 0)');
        return;
      }

      const data = {
        momo_number: momoNumber,
        momo_provider: document.getElementById('momoProvider').value,
        wallet_address: document.getElementById('walletAddress').value
      };

      try {
        const res = await fetch(`${API_URL}/users/payment-settings`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        if (result.success) {
          currentUser = { ...currentUser, ...data };
          localStorage.setItem('coinvibe_user', JSON.stringify(currentUser));
          showToast('Payment settings updated successfully!');
        } else {
          alert(result.message || 'Failed to update payment settings');
        }
      } catch (e) {
        console.error('Update failed:', e);
        showToast('Payment settings updated locally');
      }
    }

    async function updatePassword(event) {
      event.preventDefault();
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (!currentPassword || !newPassword || !confirmPassword) {
        alert('Please fill in all password fields');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('New passwords do not match');
        return;
      }

      if (newPassword.length < 8) {
        alert('Password must be at least 8 characters long');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/users/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
          })
        });

        const result = await res.json();
        if (result.success) {
          showToast('Password updated successfully!');
          resetSecurityForm();
        } else {
          alert(result.message || 'Failed to update password');
        }
      } catch (e) {
        console.error('Password update failed:', e);
        alert('Failed to update password');
      }
    }

    async function updateNotifications(event) {
      event.preventDefault();
      const data = {
        email_notifications: document.getElementById('emailNotifications').checked,
        payment_alerts: document.getElementById('paymentAlerts').checked,
        marketing_emails: document.getElementById('marketingEmails').checked
      };

      try {
        const res = await fetch(`${API_URL}/users/notifications`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        if (result.success) {
          showToast('Notification preferences updated!');
        } else {
          alert(result.message || 'Failed to update preferences');
        }
      } catch (e) {
        console.error('Update failed:', e);
        showToast('Preferences saved locally');
      }
    }

    function resetPersonalInfo() {
      loadUserProfile();
      showToast('Form reset to saved values');
    }

    function resetPaymentSettings() {
      loadUserProfile();
      showToast('Form reset to saved values');
    }

    function resetSecurityForm() {
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    function confirmDeleteAccount() {
      const confirmation = confirm('Are you sure you want to delete your account? This action cannot be undone and all your data will be permanently deleted.');
      if (confirmation) {
        const doubleCheck = prompt('Type "DELETE" to confirm account deletion:');
        if (doubleCheck === 'DELETE') {
          deleteAccount();
        } else {
          alert('Account deletion cancelled');
        }
      }
    }

    async function deleteAccount() {
      try {
        const res = await fetch(`${API_URL}/users/delete-account`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        const result = await res.json();
        if (result.success) {
          alert('Your account has been deleted. You will be logged out now.');
          localStorage.removeItem('coinvibe_token');
          localStorage.removeItem('coinvibe_user');
          window.location.href = '/';
        } else {
          alert(result.message || 'Failed to delete account');
        }
      } catch (e) {
        console.error('Account deletion failed:', e);
        alert('Failed to delete account. Please contact support.');
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      if (window.lucide && lucide.createIcons) lucide.createIcons();
      initHeader();
      loadUserProfile();
    });
  </script>
</body>

</html>