{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sell Crypto • CoinVibe Pay</title>
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="{% static 'js/sell.js' %}"></script>
</head>

<body>
  <!-- Authentication Check -->
  <script>
    // Redirect unauthenticated users to login
    (function () {
      const token = localStorage.getItem('coinvibe_token');
      const loggedIn = !!(token && token !== 'null' && token !== 'undefined' && token !== '');
      if (!loggedIn) {
        window.location.href = '/login?next=/sell';
      }
    })();
  </script>

  <header class="cvp-header">
    <div class="cvp-header-inner">
      <a href="/dashboard" class="cvp-brand">
        <div class="cvp-brand" style="margin-bottom: 1rem;">
          <img src="{% static 'images/logo.jpg' %}" alt="WestLinks Exchange" style="height: 36px; width: auto;">
          <span style="margin-left: 0.75rem;">WestLinks</span>
        </div>
      </a>

      <!-- Mobile Hamburger Menu Button -->
      <button class="mobile-nav-toggle" aria-label="Toggle navigation">
        <i data-lucide="menu" style="width: 24px; height: 24px;"></i>
      </button>

      <!-- Desktop Navigation -->
      <nav class="cvp-nav">
        <a href="/dashboard" class="cvp-link">Dashboard</a>
        <a href="/profile" class="cvp-link">Profile</a>
        <div id="dashUserMenu" style="display:flex; align-items:center; gap:.5rem; margin-left:1rem;">
          <div id="dashAvatar"
            style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg, var(--highlight-yellow), var(--highlight-cyan));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.875rem;">
            U</div>
          <span id="dashUserName" class="text-primary" style="font-weight:600;"></span>
          <button onclick="logout()" class="cvp-link"
            style="color:#ef4444; background:none; border:none; cursor:pointer;">Logout</button>
        </div>
      </nav>
    </div>
  </header>

  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="dashboard-sidebar" id="dashboardSidebar">
      <nav class="sidebar-nav">
        <div class="sidebar-section">
          <div class="sidebar-section-title">Main Menu</div>
          <a href="/dashboard" class="sidebar-link">
            <i data-lucide="layout-dashboard"></i>
            <span>Overview</span>
          </a>
          <a href="/buy" class="sidebar-link">
            <i data-lucide="arrow-down-circle"></i>
            <span>Buy Crypto</span>
          </a>
          <a href="/sell" class="sidebar-link active">
            <i data-lucide="arrow-up-circle"></i>
            <span>Sell Crypto</span>
          </a>
          <a href="/exchange" class="sidebar-link">
            <i data-lucide="refresh-cw"></i>
            <span>Exchange</span>
          </a>
          <a href="/exchange/history" class="sidebar-link">
            <i data-lucide="repeat"></i>
            <span>Exchange History</span>
          </a>
          <a href="/transactions" class="sidebar-link">
            <i data-lucide="receipt"></i>
            <span>Transactions</span>
          </a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <a href="/profile" class="sidebar-link">
            <i data-lucide="user"></i>
            <span>Profile</span>
          </a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Account</div>
          <a href="#" class="sidebar-link" onclick="logout(); return false;">
            <i data-lucide="log-out"></i>
            <span>Logout</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="dashboard-main">
      <section class="cvp-container" style="margin-top: 0; margin-bottom: 3rem;">
        <div class="text-center mb-4">
          <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">Sell Crypto</h1>
          <p class="text-secondary">Convert your cryptocurrency to Ghana Cedis</p>
        </div>

        <div class="glass-card" style="max-width: 700px; margin: 0 auto;">
          <div style="display: grid; gap: 1.5rem;">
            <div>
              <label>Asset</label>
              <select id="sellAssetSelect" class="field"></select>
            </div>
            <div>
              <label>Amount to Send($)</label>
              <input id="sellAmountUSDT" type="number" class="field" placeholder="100.00"
                oninput="updateSellCalculator()" step="0.01" min="0" />
            </div>

            <div class="glass-card"
              style="background: rgba(14, 203, 129, 0.1); border-color: rgba(14, 203, 129, 0.3); padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                <span class="text-secondary">Rate/$</span>
                <span class="text-green font-weight: 600;" id="sellRateLabel">₵--/Asset</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                <span class="text-secondary">Fee (1.5%)</span>
                <span class="text-primary font-weight: 600;" id="sellFee">₵0.00</span>
              </div>
              <div
                style="display: flex; justify-content: space-between; font-weight: 700; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                <span class="text-primary">Total</span>
                <span class="text-green" id="sellTotal">₵0.00</span>
              </div>
            </div>

            <div>
              <label>MoMo Network</label>
              <select id="sellMoMoNetwork" class="field">
                <option value="mtn">MTN Mobile Money</option>
                <option value="airtel">AirtelTigo Money</option>
                <option value="vodafone">Vodafone Cash</option>
              </select>
            </div>

            <div>
              <label>Mobile Money Number</label>
              <input id="sellMoMoNumber" type="tel" class="field" placeholder="0593021696" />
            </div>

            <div class="glass-card" style="background: var(--bg-secondary); padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <span class="text-secondary font-weight: 500;">Admin Wallet</span>
                <button onclick="copyWalletAddress()" class="text-cyan"
                  style="background: none; border: 1px solid var(--border-color); cursor: pointer; font-size: 0.875rem; transition: all 0.3s; padding: 8px 12px; border-radius: 8px; min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent;">
                  <i data-lucide="copy"></i>
                </button>
              </div>
              <div id="confirmAdminWallet" class="font-mono text-xs"
                style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px; word-break: break-all; color: var(--text-primary);">
                --</div>
            </div>
            <div>
              <label>Blockchain Tx Hash (optional)</label>
              <input id="sellTxHash" type="text" class="field"
                placeholder="Paste the transaction hash after sending funds" />
            </div>

            <button onclick="confirmSell()" class="btn btn-success" style="width: 100%;">Confirm Sell Order</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="sellToast"
    style="display: none; position: fixed; bottom: var(--spacing-lg); right: var(--spacing-lg); background: var(--bg-card); border: 1px solid var(--highlight-green); border-radius: 12px; padding: var(--spacing-md); box-shadow: var(--shadow-lg), var(--glow-green); z-index: 2000; min-width: 300px;">
    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
      <i data-lucide="check-circle" style="width: 24px; height: 24px; color: var(--highlight-green);"></i>
      <div>
        <div style="font-weight: 600; color: var(--text-primary);">Notice</div>
        <div class="text-secondary" style="font-size: 0.875rem;" id="sellToastMsg">Processing…</div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const brand = document.getElementById('cvpBrand');
      const t = localStorage.getItem('coinvibe_token');
      const loggedIn = !!(t && t !== 'null' && t !== 'undefined' && t !== '');
      if (brand) brand.setAttribute('href', loggedIn ? '/dashboard' : '/');
      if (window.lucide && lucide.createIcons) lucide.createIcons();
      initHeader();
    });

    function initHeader() {
      const currentUser = JSON.parse(localStorage.getItem('coinvibe_user') || '{}');
      const name = currentUser && (currentUser.name || currentUser.username || currentUser.full_name) ? (currentUser.name || currentUser.username || currentUser.full_name) : '';

      const userNameEl = document.getElementById('dashUserName');
      if (userNameEl) userNameEl.textContent = name;

      const avatarEl = document.getElementById('dashAvatar');
      if (avatarEl) avatarEl.textContent = name ? name.charAt(0).toUpperCase() : 'U';
    }

    function logout() {
      localStorage.removeItem('coinvibe_token');
      localStorage.removeItem('coinvibe_user');
      window.location.href = '/';
    }

    // Sidebar Logic
    (function () {
      const sidebar = document.getElementById('dashboardSidebar');
      const toggleBtn = document.querySelector('.sidebar-toggle');
      const mobileToggle = document.querySelector('.mobile-nav-toggle');
      const body = document.body;

      let backdrop = document.getElementById('sidebarBackdrop');
      if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.id = 'sidebarBackdrop';
        backdrop.className = 'sidebar-backdrop';
        document.body.appendChild(backdrop);
      }

      function isMobileWidth() {
        return window.innerWidth <= 1024;
      }

      function openSidebar() {
        if (!sidebar) return;
        sidebar.classList.add('active');
        backdrop.classList.add('visible');
        body.style.overflow = 'hidden';
      }

      function closeSidebar() {
        if (!sidebar) return;
        sidebar.classList.remove('active');
        backdrop.classList.remove('visible');
        body.style.overflow = '';
      }

      window.toggleSidebar = function () {
        if (!sidebar) return;
        if (sidebar.classList.contains('active')) closeSidebar();
        else openSidebar();
      }

      if (toggleBtn) toggleBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        toggleSidebar();
      });

      if (mobileToggle) mobileToggle.addEventListener('click', function (e) {
        e.stopPropagation();
        toggleSidebar();
      });

      backdrop.addEventListener('click', closeSidebar);

      window.addEventListener('resize', function () {
        if (!isMobileWidth()) {
          sidebar.classList.remove('open');
          backdrop.classList.remove('visible');
          body.style.overflow = '';
        }
      });

      sidebar.addEventListener('click', function (ev) {
        const link = ev.target.closest('a');
        if (link && isMobileWidth()) {
          setTimeout(closeSidebar, 150);
        }
      });
    })();
  </script>
</body>

</html>