{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exchange Currency ‚Ä¢ CoinVibe Pay</title>
    <link rel="stylesheet" href="{% static 'css/app.css' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/naira-cedi.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="{% static 'js/naira-cedi.js' %}"></script>
</head>

<body>
    <!-- Auth Check -->
    <script>
        (function () {
            const token = localStorage.getItem('coinvibe_token');
            if (!token) window.location.href = '/login?next=/exchange';
        })();
    </script>
    <header class="cvp-header">
        <div class="cvp-header-inner">
            <a href="/dashboard" class="cvp-brand">
                <img src="{% static 'images/logo.jpg' %}" alt="WestLinks Exchange" style="height: 36px; width: auto;">
                <span style="margin-left: 0.75rem;">WestLinks</span>
            </a>

            <!-- Mobile Hamburger Menu Button -->
            <button class="mobile-nav-toggle" onclick="toggleSidebar()" aria-label="Toggle navigation">
                <i data-lucide="menu" style="width: 24px; height: 24px;"></i>
            </button>

            <!-- Desktop Navigation -->
            <nav class="cvp-nav">
                <a href="/dashboard" class="cvp-link">Dashboard</a>
                <a href="/profile" class="cvp-link">Profile</a>
                <div id="dashUserMenu" style="display:flex; align-items:center; gap:.5rem; margin-left:1rem;">
                    <div id="dashAvatar"
                        style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg, var(--highlight-yellow), var(--highlight-cyan));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.875rem;">
                        U</div>
                    <span id="dashUserName" class="text-primary" style="font-weight:600;"></span>
                    <button onclick="logout()" class="cvp-link"
                        style="color:#ef4444; background:none; border:none; cursor:pointer;">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Backdrop for mobile sidebar -->
    <div class="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <div class="dashboard-layout">
        <!-- Sidebar (Same as dashboard) -->
        <aside class="dashboard-sidebar" id="dashboardSidebar">
            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Main Menu</div>
                    <a href="/dashboard" class="sidebar-link">
                        <i data-lucide="layout-dashboard"></i>
                        <span>Overview</span>
                    </a>
                    <a href="/buy" class="sidebar-link">
                        <i data-lucide="arrow-down-circle"></i>
                        <span>Buy Crypto</span>
                    </a>
                    <a href="/sell" class="sidebar-link">
                        <i data-lucide="arrow-up-circle"></i>
                        <span>Sell Crypto</span>
                    </a>
                    <a href="/exchange" class="sidebar-link active">
                        <i data-lucide="refresh-cw"></i>
                        <span>Exchange</span>
                    </a>
                    <a href="/transactions" class="sidebar-link">
                        <i data-lucide="receipt"></i>
                        <span>Transactions</span>
                    </a>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Account</div>
                    <a href="/profile" class="sidebar-link">
                        <i data-lucide="user"></i>
                        <span>Profile</span>
                    </a>
                    <a href="#" class="sidebar-link" onclick="logout(); return false;">
                        <i data-lucide="log-out"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="dashboard-main">
            <div class="exchange-container">
                <h1 class="page-title" style="margin-bottom: 24px;">Currency Exchange</h1>

                <div class="currency-toggle">
                    <button class="toggle-btn active" onclick="setDirection('NGN_GHS')" id="btnNgnGhs">
                        <img src="https://flagcdn.com/w40/ng.png" class="flag-icon" alt="NG">
                        NGN ‚Üí GHS
                    </button>
                    <button class="toggle-btn" onclick="setDirection('GHS_NGN')" id="btnGhsNgn">
                        <img src="https://flagcdn.com/w40/gh.png" class="flag-icon" alt="GH">
                        GHS ‚Üí NGN
                    </button>
                </div>

                <div class="exchange-card">
                    <!-- Step 1: Calculator -->
                    <div id="step1">
                        <div class="input-group">
                            <label class="input-label">You Send</label>
                            <div class="amount-input-wrapper" id="sendAmountWrapper">
                                <input type="number" id="sendAmount" class="amount-input" placeholder="0.00"
                                    oninput="calculateQuote()">
                                <div class="currency-badge">
                                    <img src="" id="sendFlag" class="flag-icon">
                                    <span id="sendCurrency">NGN</span>
                                </div>
                            </div>
                            <div id="amountError" class="validation-message"
                                style="display:none; margin-top: 8px; font-size: 0.85rem; color: #ef4444;"></div>
                        </div>

                        <div class="exchange-rate-info">
                            <span>Exchange Rate</span>
                            <span id="rateDisplay">Loading...</span>
                        </div>

                        <div class="input-group">
                            <label class="input-label">You Receive</label>
                            <div class="amount-input-wrapper" style="background: var(--bg-tertiary);">
                                <input type="text" id="receiveAmount" class="amount-input" placeholder="0.00" readonly>
                                <div class="currency-badge">
                                    <img src="" id="receiveFlag" class="flag-icon">
                                    <span id="receiveCurrency">GHS</span>
                                </div>
                            </div>
                        </div>

                        <div class="fee-breakdown hidden" id="feeBreakdown">
                            <div class="fee-row">
                                <span>Exchange Fee (<span id="feePercent">2</span>%)</span>
                                <span id="feeAmount">0.00</span>
                            </div>
                            <div class="fee-row total">
                                <span>Total to Receive</span>
                                <span id="netAmount">0.00</span>
                            </div>
                        </div>

                        <div class="recipient-form">
                            <h3 style="font-size: 1.1rem; margin-bottom: 16px;">Recipient Details</h3>

                            <!-- GHS Recipient (MoMo) -->
                            <div id="ghsRecipientForm">
                                <div class="form-group" style="margin-bottom: 16px;">
                                    <label class="input-label">Mobile Money Number</label>
                                    <input type="tel" id="momoNumber" class="form-control" placeholder="024XXXXXXX"
                                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                                </div>
                                <div class="form-group">
                                    <label class="input-label">Account Name</label>
                                    <input type="text" id="momoName" class="form-control" placeholder="John Doe"
                                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                                </div>
                            </div>

                            <!-- NGN Recipient (Bank) -->
                            <div id="ngnRecipientForm" class="hidden">
                                <div class="form-group" style="margin-bottom: 16px;">
                                    <label class="input-label">Bank Name</label>
                                    <input type="text" id="bankName" class="form-control" placeholder="e.g. GTBank"
                                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                                </div>
                                <div class="form-group" style="margin-bottom: 16px;">
                                    <label class="input-label">Account Number</label>
                                    <input type="tel" id="accountNumber" class="form-control" placeholder="0123456789"
                                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                                </div>
                                <div class="form-group">
                                    <label class="input-label">Account Name</label>
                                    <input type="text" id="accountName" class="form-control" placeholder="John Doe"
                                        style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                                </div>
                            </div>
                        </div>

                        <button onclick="createExchange()" class="btn btn-primary"
                            style="width: 100%; margin-top: 24px; padding: 16px; font-size: 1.1rem;" id="exchangeBtn">
                            Proceed to Exchange
                        </button>
                    </div>

                    <!-- Step 2: Payment -->
                    <div id="step2" class="hidden">
                        <div style="text-align: center; margin-bottom: 24px;">
                            <div
                                style="width: 64px; height: 64px; background: var(--bg-tertiary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                                <i data-lucide="credit-card"
                                    style="width: 32px; height: 32px; color: var(--highlight-yellow);"></i>
                            </div>
                            <h2>Complete Payment</h2>
                            <p class="text-secondary">Please complete the payment to process your exchange</p>
                        </div>

                        <div
                            style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; margin-bottom: 24px;">
                            <div class="fee-row">
                                <span>Amount to Pay</span>
                                <span id="payAmount" style="font-weight: 700;">0.00</span>
                            </div>
                            <div class="fee-row">
                                <span>Reference</span>
                                <span id="payRef" style="font-family: monospace;">--</span>
                            </div>
                        </div>

                        <!-- NGN Payment Instructions -->
                        <div id="ngnPayment" class="hidden">
                            <div
                                style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <h3 style="font-size: 1rem; margin-bottom: 16px; color: var(--highlight-yellow);">üá≥üá¨
                                    Bank Transfer Details</h3>
                                <div style="display: grid; gap: 12px;">
                                    <div class="fee-row">
                                        <span>Bank Name:</span>
                                        <span id="ngnBankName" style="font-weight: 600;">Loading...</span>
                                    </div>
                                    <div class="fee-row">
                                        <span>Account Number:</span>
                                        <span id="ngnAccountNumber"
                                            style="font-weight: 600; font-family: monospace;">Loading...</span>
                                    </div>
                                    <div class="fee-row">
                                        <span>Account Name:</span>
                                        <span id="ngnAccountName" style="font-weight: 600;">Loading...</span>
                                    </div>
                                </div>
                                <div
                                    style="margin-top: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                                        ‚ö†Ô∏è <strong>Important:</strong> Use <strong id="payRefCopy">--</strong> as your
                                        transfer reference
                                    </p>
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 16px;">
                                <label class="input-label">Payment Reference / Transaction ID</label>
                                <input type="text" id="ngnTxId" class="form-control"
                                    placeholder="Enter your bank transfer reference"
                                    style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            </div>

                            <div class="form-group" style="margin-bottom: 16px;">
                                <label class="input-label">Upload Proof of Payment (Screenshot)</label>
                                <input type="file" id="ngnProof" accept="image/*" class="form-control"
                                    style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">
                                    Upload a screenshot of your bank transfer receipt
                                </p>
                            </div>

                            <button onclick="confirmPayment('NGN')" class="btn btn-primary"
                                style="width: 100%; padding: 16px;">
                                ‚úÖ I have completed the payment
                            </button>
                        </div>

                        <!-- GHS Payment Instructions -->
                        <div id="ghsPayment" class="hidden">
                            <div
                                style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <h3 style="font-size: 1rem; margin-bottom: 16px; color: var(--highlight-yellow);">üá¨üá≠
                                    Mobile Money Details</h3>
                                <div style="display: grid; gap: 12px;">
                                    <div class="fee-row">
                                        <span>MoMo Number:</span>
                                        <span id="ghsMomoNumber"
                                            style="font-weight: 600; font-family: monospace;">Loading...</span>
                                    </div>
                                    <div class="fee-row">
                                        <span>Account Name:</span>
                                        <span id="ghsMomoName" style="font-weight: 600;">Loading...</span>
                                    </div>
                                    <div class="fee-row">
                                        <span>Network:</span>
                                        <span id="ghsMomoNetwork" style="font-weight: 600;">Loading...</span>
                                    </div>
                                    <div class="fee-row">
                                        <span>Amount to Send:</span>
                                        <span id="ghsPayAmountDisplay"
                                            style="font-weight: 700; color: var(--highlight-yellow);">GH‚Çµ 0.00</span>
                                    </div>
                                </div>
                                <div
                                    style="margin-top: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                                        ‚ö†Ô∏è <strong>Important:</strong> Use <strong id="payRefCopyGhs">--</strong> as
                                        reference/description
                                    </p>
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 16px;">
                                <label class="input-label">MoMo Transaction Reference</label>
                                <input type="text" id="momoTxId" class="form-control"
                                    placeholder="Transaction reference from SMS"
                                    style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                            </div>

                            <div class="form-group" style="margin-bottom: 16px;">
                                <label class="input-label">Upload Proof of Payment (Screenshot)</label>
                                <input type="file" id="ghsProof" accept="image/*" class="form-control"
                                    style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary);">
                                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">
                                    Upload a screenshot of your MoMo transaction receipt
                                </p>
                            </div>

                            <button onclick="confirmPayment('GHS')" class="btn btn-primary"
                                style="width: 100%; padding: 16px;">
                                ‚úÖ I have sent the money
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>


</body>

</html>