{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buy Crypto • WestLinks Exchange</title>
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

</head>

<body>
  <script>
    (function () {
      const token = localStorage.getItem('coinvibe_token');
      const loggedIn = !!(token && token !== 'null' && token !== 'undefined' && token !== '');
      if (!loggedIn) {
        window.location.href = '/login?next=/buy';
      }
    })();
  </script>

  <header class="cvp-header">
    <div class="cvp-header-inner">
      <a href="/dashboard" class="cvp-brand">
        <div class="cvp-brand" style="margin-bottom: 1rem;">
          <img src="{% static 'images/logo.jpg' %}" alt="WestLinks Exchange" style="height: 36px; width: auto;">
          <span style="margin-left: 0.75rem;">WestLinks</span>
        </div>
      </a>

      <!-- Mobile Hamburger Menu Button -->
      <button class="mobile-nav-toggle" aria-label="Toggle navigation">
        <i data-lucide="menu" style="width: 24px; height: 24px;"></i>
      </button>

      <!-- Desktop Navigation -->
      <nav class="cvp-nav">
        <a href="/dashboard" class="cvp-link">Dashboard</a>
        <a href="/profile" class="cvp-link">Profile</a>
        <div id="dashUserMenu" style="display:flex; align-items:center; gap:.5rem; margin-left:1rem;">
          <div id="dashAvatar"
            style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg, var(--highlight-yellow), var(--highlight-cyan));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.875rem;">
            U</div>
          <span id="dashUserName" class="text-primary" style="font-weight:600;"></span>
          <button onclick="logout()" class="cvp-link"
            style="color:#ef4444; background:none; border:none; cursor:pointer;">Logout</button>
        </div>
      </nav>
    </div>
  </header>

  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="dashboard-sidebar" id="dashboardSidebar">
      <nav class="sidebar-nav">
        <div class="sidebar-section">
          <div class="sidebar-section-title">Main Menu</div>
          <a href="/dashboard" class="sidebar-link">
            <i data-lucide="layout-dashboard"></i>
            <span>Overview</span>
          </a>
          <a href="/buy" class="sidebar-link active">
            <i data-lucide="arrow-down-circle"></i>
            <span>Buy Crypto</span>
          </a>
          <a href="/sell" class="sidebar-link">
            <i data-lucide="arrow-up-circle"></i>
            <span>Sell Crypto</span>
          </a>
          <a href="/exchange" class="sidebar-link">
            <i data-lucide="refresh-cw"></i>
            <span>Exchange</span>
          </a>
          <a href="/exchange/history" class="sidebar-link">
            <i data-lucide="repeat"></i>
            <span>Exchange History</span>
          </a>
          <a href="/transactions" class="sidebar-link">
            <i data-lucide="receipt"></i>
            <span>Transactions</span>
          </a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Account</div>
          <a href="/profile" class="sidebar-link">
            <i data-lucide="user"></i>
            <span>Profile</span>
          </a>
          <button onclick="logout()" class="sidebar-link"
            style="width:100%; text-align:left; background:none; border:none; cursor:pointer;">
            <i data-lucide="log-out"></i>
            <span>Logout</span>
          </button>
        </div>
      </nav>
    </aside>

    <main class="dashboard-main">
      <div class="dashboard-content">

        <!-- Step 1: Calculator & Order Creation -->
        <div id="buyStep1">
          <h2 id="buyPageTitle" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Buy Crypto</h2>

          <div class="glass-card" style="padding: 1.5rem; margin-bottom: 2rem;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
              <div>
                <label>I Pay (GHS)</label>
                <input id="buyAmountGHS" type="number" class="field" placeholder="0.00"
                  oninput="updateBuyCalculator()" />
              </div>
              <div>
                <label id="buyGetLabel">Value in USD</label>
                <input id="buyAmountUSDT" type="text" class="field" readonly placeholder="0.00" />
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.5rem;">
              <span class="text-secondary">Rate</span>
              <span class="text-primary" id="buyRateLabel">--</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.5rem;">
              <span class="text-secondary">Service Fee (<span id="buyFeePercent">1.5</span>%)</span>
              <span class="text-primary" id="buyServiceFee">--</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.5rem;">
              <span class="text-secondary">Network Fee</span>
              <span class="text-primary" id="buyNetworkFee">--</span>
            </div>
            <div
              style="display: flex; justify-content: space-between; font-weight: 700; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
              <span class="text-primary">Total to Pay</span>
              <span class="text-yellow" id="buyTotal">₵0.00</span>
            </div>
          </div>

          <h3 style="font-size: 1.25rem; font-weight: 700; margin-top: 1rem; margin-bottom: 1rem;">Wallet Details</h3>

          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
              <label>Asset</label>
              <select id="buyAssetSelect" class="field">
                <option value="USDT">USDT</option>
                <option value="TRX">TRON (TRX)</option>
                <option value="LTC">Litecoin (LTC)</option>
              </select>
            </div>
            <div>
              <label>Network</label>
              <select id="buyNetworkSelect" class="field"></select>
            </div>
          </div>

          <div>
            <label>Your Wallet Address</label>
            <input id="buyWalletAddress" type="text" class="field" placeholder="Enter wallet address" />
            <div id="buyWalletError" style="display: none; color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem;">
              Invalid address for selected network.</div>
            <div class="text-muted" style="font-size: 0.75rem; margin-top: 0.5rem;">Estimated blockchain fee: <span
                id="buyBlockchainFee" style="font-weight: 600;">--</span></div>
          </div>

          <div style="margin-top: 2rem;">
            <button onclick="createBuyOrder()" class="btn btn-primary" style="width: 100%;">Proceed to Payment</button>
          </div>
        </div>

        <!-- Step 2: Payment Instructions -->
        <div id="buyStep2" style="display: none;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
            <button onclick="showStep1()"
              style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">
              <i data-lucide="arrow-left"></i>
            </button>
            <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0;">Complete Payment</h2>
          </div>

          <div class="glass-card" style="padding: 1.5rem; margin-bottom: 2rem; border-color: var(--highlight-yellow);">
            <div style="text-align: center; margin-bottom: 1.5rem;">
              <div style="font-size: 0.875rem; color: var(--text-secondary);">Amount to Pay</div>
              <div id="payAmountDisplay" style="font-size: 2rem; font-weight: 800; color: var(--highlight-yellow);">
                ₵0.00</div>
              <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">Order ID: <span
                  id="payOrderId" style="font-family: monospace; color: var(--text-primary);">--</span></div>
            </div>

            <div
              style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 4px; display: flex; margin-bottom: 1.5rem;">
              <button onclick="togglePaymentMethod('momo')" id="btnMomo" class="btn"
                style="flex: 1; background: var(--highlight-yellow); color: #000; border: none;">Mobile Money</button>
              <button onclick="togglePaymentMethod('bank')" id="btnBank" class="btn"
                style="flex: 1; background: transparent; color: var(--text-secondary); border: none;">Bank
                Transfer</button>
            </div>

            <!-- Mobile Money Details -->
            <div id="momoDetails">
              <div style="display: grid; gap: 1rem;">
                <div
                  style="display: flex; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                  <span class="text-secondary">MoMo Number</span>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span id="payMomoNumber" style="font-weight: 600; font-family: monospace;">--</span>
                    <i data-lucide="copy" style="width: 14px; cursor: pointer;" onclick="copyText('payMomoNumber')"></i>
                  </div>
                </div>
                <div
                  style="display: flex; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                  <span class="text-secondary">Account Name</span>
                  <span id="payMomoName" style="font-weight: 600;">--</span>
                </div>
                <div
                  style="display: flex; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                  <span class="text-secondary">Network</span>
                  <span id="payMomoNetwork" style="font-weight: 600;">--</span>
                </div>
              </div>
            </div>

            <!-- Bank Details -->
            <div id="bankDetails" style="display: none;">
              <div style="display: grid; gap: 1rem;">
                <div
                  style="display: flex; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                  <span class="text-secondary">Bank Name</span>
                  <span id="payBankName" style="font-weight: 600;">--</span>
                </div>
                <div
                  style="display: flex; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                  <span class="text-secondary">Account Number</span>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span id="payAccountNumber" style="font-weight: 600; font-family: monospace;">--</span>
                    <i data-lucide="copy" style="width: 14px; cursor: pointer;"
                      onclick="copyText('payAccountNumber')"></i>
                  </div>
                </div>
                <div
                  style="display: flex; justify-content: space-between; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                  <span class="text-secondary">Account Name</span>
                  <span id="payAccountName" style="font-weight: 600;">--</span>
                </div>
              </div>
            </div>

            <div
              style="margin-top: 1.5rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px;">
              <div style="display: flex; gap: 0.75rem;">
                <i data-lucide="alert-triangle" style="color: #ef4444; width: 20px; height: 20px;"></i>
                <div>
                  <div style="font-weight: 600; color: #ef4444; margin-bottom: 0.25rem;">Important</div>
                  <div style="font-size: 0.875rem; color: var(--text-secondary);">
                    Please use <span id="payRefCopy"
                      style="font-weight: 700; color: var(--text-primary); font-family: monospace;">--</span> as your
                    reference/description when making the payment.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-bottom: 2rem;">
            <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">Confirm Payment</h3>

            <div style="margin-bottom: 1rem;">
              <label>Payment Reference / Transaction ID</label>
              <input id="userPayRef" type="text" class="field"
                placeholder="Enter the transaction ID from your payment" />
            </div>

            <button onclick="confirmBuyPayment()" class="btn btn-primary" style="width: 100%;">
              I have sent the money
            </button>
          </div>
        </div>

        <div id="buyToast" style="display: none; position: fixed; bottom: var(--spacing-lg); right: var(--spacing-lg); background:
          var(--bg-card); border: 1px solid var(--highlight-cyan); border-radius: 12px; padding: var(--spacing-md);
          box-shadow: var(--shadow-lg), var(--glow-cyan); z-index: 2000; min-width: 300px;">
          <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
            <i data-lucide="info" style="width: 24px; height: 24px; color: var(--highlight-cyan);"></i>
            <div>
              <div style="font-weight: 600; color: var(--text-primary);">Notice</div>
              <div class="text-secondary" style="font-size: 0.875rem;" id="buyToastMsg">Processing…</div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>
  <script src="{% static 'js/buy.js' %}"></script>
</body>

</html>