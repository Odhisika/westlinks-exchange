{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment Successful â€¢ WestLinks Exchange</title>
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</head>

<body>
  <header class="cvp-header">
    <div class="cvp-header-inner">
      <a href="/" class="cvp-brand">
        <img src="{% static 'images/logo.jpg' %}" alt="WestLinks Exchange" style="height: 36px; width: auto;">
        <span style="margin-left: 0.75rem;">WestLinks Exchange</span>
      </a>
      <nav class="cvp-nav">
        <a href="/dashboard" class="cvp-link">Dashboard</a>
        <a href="/profile" class="cvp-link">Profile</a>
      </nav>
    </div>
  </header>

  <section class="cvp-container" style="margin-top: 3rem; margin-bottom: 3rem;">
    <div class="glass-card" style="max-width: 720px; margin: 0 auto; padding: 2rem;">
      <div style="display:flex; align-items:center; gap:1rem;">
        <i data-lucide="check-circle"
          style="width: 40px; height: 40px; color: {{ success|yesno:'var(--highlight-green),#ef4444' }};"></i>
        <div>
          <h1 style="font-size:1.75rem; font-weight:800; margin:0;">
            {% if success %}
            order successful
            {% else %}
            order verification failed
            {% endif %}
          </h1>
          <p class="text-secondary" style="margin-top:0.25rem;">
            {% if success %}
            We have successfully received your order.
            We'll verify the payment and deliver it to you as soon as possible.
            {% else %}
            We could not verify this payment at the moment.
            If you completed the payment, please contact support with your reference code below.
            {% endif %}
          </p>
        </div>
      </div>

      <div style="margin-top:1.5rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
        <div class="glass-card" style="padding:1rem;">
          <div class="text-secondary" style="font-size:0.875rem;">Reference</div>
          <div class="font-mono" style="font-weight:600;">{{ reference }}</div>
        </div>
        <div class="glass-card" style="padding:1rem;">
          <div class="text-secondary" style="font-size:0.875rem;">Status</div>
          <div style="font-weight:600; color: {% if success %}var(--highlight-green){% else %}#ef4444{% endif %};">
            {{ status|capfirst }} {{ success|yesno:'(Success,Failed)' }}</div>
        </div>
      </div>

      <div style="margin-top:2rem; display:flex; gap:0.75rem;">
        <a href="/dashboard" class="btn {% if success %}btn-success{% else %}btn-secondary{% endif %}">Go to
          Dashboard</a>
        <a href="/buy" class="btn btn-primary">Start a New Buy</a>
      </div>
    </div>

    <!-- Review Section (only show on success) -->
    {% if success %}
    <div class="glass-card" id="reviewSection" style="max-width: 720px; margin: 2rem auto; padding: 2rem;">
      <div style="text-align: center;">
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">How was your experience?</h2>
        <p class="text-secondary" style="margin-bottom: 1.5rem;">Your feedback helps us improve our service</p>
      </div>

      <div id="reviewForm">
        <!-- Star Rating -->
        <div style="display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 1.5rem;">
          <i data-lucide="star" class="rating-star" data-rating="1"
            style="width: 36px; height: 36px; cursor: pointer; color: rgba(255,255,255,0.2); transition: all 0.2s;"></i>
          <i data-lucide="star" class="rating-star" data-rating="2"
            style="width: 36px; height: 36px; cursor: pointer; color: rgba(255,255,255,0.2); transition: all 0.2s;"></i>
          <i data-lucide="star" class="rating-star" data-rating="3"
            style="width: 36px; height: 36px; cursor: pointer; color: rgba(255,255,255,0.2); transition: all 0.2s;"></i>
          <i data-lucide="star" class="rating-star" data-rating="4"
            style="width: 36px; height: 36px; cursor: pointer; color: rgba(255,255,255,0.2); transition: all 0.2s;"></i>
          <i data-lucide="star" class="rating-star" data-rating="5"
            style="width: 36px; height: 36px; cursor: pointer; color: rgba(255,255,255,0.2); transition: all 0.2s;"></i>
        </div>

        <!-- Comment Textarea -->
        <textarea id="reviewComment" placeholder="Share your experience with us (optional)..."
          style="width: 100%; min-height: 100px; padding: 1rem; background: rgba(20,30,50,0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: inherit; resize: vertical; margin-bottom: 1rem;"></textarea>

        <!-- Submit Button -->
        <button onclick="submitReview()" class="btn btn-primary" style="width: 100%;" id="submitReviewBtn">
          Submit Review
        </button>
      </div>

      <!-- Thank You Message (hidden initially) -->
      <div id="thankYouMessage" style="display: none; text-align: center;">
        <i data-lucide="check-circle"
          style="width: 64px; height: 64px; color: var(--highlight-green); margin-bottom: 1rem;"></i>
        <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">Thank You for Your Feedback!</h3>
        <p class="text-secondary">Your review will be published after admin approval.</p>
      </div>
    </div>
    {% endif %}
  </section>

  <script>
    const API_URL = '/api';
    let selectedRating = 0;

    document.addEventListener('DOMContentLoaded', function () {
      if (window.lucide && lucide.createIcons) lucide.createIcons();

      // Star rating interaction
      const stars = document.querySelectorAll('.rating-star');
      stars.forEach(star => {
        star.addEventListener('click', function () {
          selectedRating = parseInt(this.getAttribute('data-rating'));
          updateStars();
        });

        star.addEventListener('mouseenter', function () {
          const rating = parseInt(this.getAttribute('data-rating'));
          highlightStars(rating);
        });
      });

      // Reset on mouse leave
      const ratingContainer = document.querySelector('.rating-star')?.parentElement;
      if (ratingContainer) {
        ratingContainer.addEventListener('mouseleave', function () {
          highlightStars(selectedRating);
        });
      }
    });

    function highlightStars(rating) {
      const stars = document.querySelectorAll('.rating-star');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.style.color = '#fbbf24';
          star.setAttribute('fill', 'currentColor');
        } else {
          star.style.color = 'rgba(255,255,255,0.2)';
          star.setAttribute('fill', 'none');
        }
      });
      if (window.lucide && lucide.createIcons) {
        lucide.createIcons();
      }
    }

    function updateStars() {
      highlightStars(selectedRating);
    }

    function submitReview() {
      const comment = document.getElementById('reviewComment').value.trim();
      const submitBtn = document.getElementById('submitReviewBtn');

      // Validate rating
      if (selectedRating === 0) {
        alert('Please select a rating');
        return;
      }

      // Validate comment
      if (!comment) {
        alert('Please share your experience');
        return;
      }

      // Disable button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      // Get vendor email from session (you might need to adjust this)
      const vendorEmail = '{{ request.session.vendor_email|default:"" }}' || localStorage.getItem('vendor_email');
      const orderReference = '{{ reference }}';

      fetch(`${API_URL}/reviews/submit`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          vendor_email: vendorEmail,
          rating: selectedRating,
          comment: comment,
          buy_order_id: orderReference
        })
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            // Show thank you message
            document.getElementById('reviewForm').style.display = 'none';
            document.getElementById('thankYouMessage').style.display = 'block';
            if (window.lucide && lucide.createIcons) {
              lucide.createIcons();
            }
          } else {
            alert(data.error || 'Failed to submit review. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Review';
          }
        })
        .catch(err => {
          console.error('Error submitting review:', err);
          alert('Failed to submit review. Please try again later.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Review';
        });
    }
  </script>
</body>

</html>