{% extends 'base.html' %}
{% block title %}Sign Up - WestLinks Exchange{% endblock %}
{% block content %}
<section class="cvp-container"
  style="margin-top: 4rem; margin-bottom: 4rem; min-height: 60vh; display: flex; align-items: center; justify-content: center;">
  <div class="glass-card" style="max-width: 550px; width: 100%;">
    <div class="text-center mb-4">
      <h1 style="font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem;">Create Your Account</h1>
      <p class="text-secondary">Join thousands trading crypto</p>
    </div>

    <form onsubmit="submitRegister(event)" style="display: grid; gap: 1.5rem;">
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
        <div>
          <label>Full Name</label>
          <input id="regName" type="text" class="field" placeholder="John Doe" required />
        </div>
        <div>
          <label>Country</label>
          <select id="regCountry" class="field">
            <option value="GH">Ghana</option>
            <option value="NG">Nigeria</option>
          </select>
        </div>
      </div>

      <div>
        <label>Email</label>
        <input id="regEmail" type="email" class="field" placeholder="you@example.com" required />
      </div>

      <div>
        <label>Mobile Money Number</label>
        <input id="regMomo" type="tel" class="field" placeholder="0591234567" required maxlength="10" pattern="0\d{9}"
          title="Ghana phone numbers must be exactly 10 digits starting with 0" />
      </div>

      <div>
        <label>Create Password</label>
        <div style="position: relative;">
          <input id="regPassword" type="password" class="field" placeholder="Strong password" required
            oninput="checkPasswordStrength()" style="padding-right: 40px;" />
          <button type="button" onclick="togglePasswordVisibility('regPassword', 'togglePass1')"
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary);">
            <i id="togglePass1" data-lucide="eye" style="width: 20px; height: 20px;"></i>
          </button>
        </div>
        <!-- Password strength indicator -->
        <div id="strengthBar"
          style="height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 8px; overflow: hidden;">
          <div id="strengthFill" style="height: 100%; width: 0%; transition: all 0.3s; background: #ef4444;"></div>
        </div>
        <p id="strengthText" style="font-size: 0.75rem; margin-top: 4px; color: var(--text-secondary);"></p>
      </div>

      <div>
        <label>Confirm Password</label>
        <div style="position: relative;">
          <input id="regPasswordConfirm" type="password" class="field" placeholder="Re-enter password" required
            oninput="checkPasswordMatch()" style="padding-right: 40px;" />
          <button type="button" onclick="togglePasswordVisibility('regPasswordConfirm', 'togglePass2')"
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary);">
            <i id="togglePass2" data-lucide="eye" style="width: 20px; height: 20px;"></i>
          </button>
        </div>
        <p id="matchText" style="font-size: 0.75rem; margin-top: 4px; color: var(--text-secondary);"></p>
      </div>

      <!-- Password requirements -->
      <div
        style="background: rgba(6, 182, 212, 0.05); border-left: 3px solid var(--highlight-cyan); padding: 12px; border-radius: 6px; font-size: 0.875rem;">
        <p style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Password must contain:</p>
        <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); line-height: 1.8;">
          <li id="req-length">At least 8 characters</li>
          <li id="req-upper">One uppercase letter</li>
          <li id="req-lower">One lowercase letter</li>
          <li id="req-number">One number</li>
        </ul>
      </div>

      <div id="regError"
        style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 0.75rem; color: #ef4444; font-size: 0.875rem;">
      </div>

      <button type="submit" class="btn btn-success" style="width: 100%;">Create Account</button>
    </form>

    <div class="text-center" style="margin-top: 1.5rem;">
      <a href="/login" class="text-cyan" style="text-decoration: none; transition: color 0.3s;">Already have an account?
        Sign In</a>
    </div>
  </div>

  <!-- Verification Modal -->
  <div id="verifyModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div class="glass-card" style="max-width: 400px; width: 90%; padding: 2rem;">
      <div class="text-center mb-4">
        <div
          style="width: 50px; height: 50px; background: rgba(6, 182, 212, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
          <i data-lucide="mail" style="color: var(--highlight-cyan); width: 24px; height: 24px;"></i>
        </div>
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">Verify Your Email</h2>
        <p class="text-secondary" style="font-size: 0.875rem;">We sent a 6-digit code to <span id="verifyEmailDisplay"
            style="color: var(--text-primary); font-weight: 600;"></span></p>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <input id="verifyCode" type="text" class="field" placeholder="Enter 6-digit code" maxlength="6"
          style="text-align: center; letter-spacing: 4px; font-size: 1.25rem; font-weight: 700;" />
      </div>

      <div id="verifyError"
        style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 0.75rem; color: #ef4444; font-size: 0.875rem; margin-bottom: 1rem; text-align: center;">
      </div>

      <button onclick="submitVerification()" id="verifyBtn" class="btn btn-success"
        style="width: 100%; margin-bottom: 1rem;">Verify Email</button>

      <button onclick="resendVerification()" id="resendBtn"
        style="width: 100%; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 0.875rem;">
        Didn't receive code? <span class="text-cyan">Resend</span>
      </button>
    </div>
  </div>
</section>

<script>
  const API_URL = window.location.origin + '/api';
  let pendingEmail = '';

  function togglePasswordVisibility(inputId, iconId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(iconId);
    if (input.type === 'password') {
      input.type = 'text';
      icon.setAttribute('data-lucide', 'eye-off');
    } else {
      input.type = 'password';
      icon.setAttribute('data-lucide', 'eye');
    }
    if (window.lucide) lucide.createIcons();
  }

  function checkPasswordStrength() {
    const password = document.getElementById('regPassword').value;
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');

    let score = 0;
    let feedback = '';

    // Check length
    if (password.length >= 8) {
      score += 25;
      document.getElementById('req-length').style.color = '#10b981';
    } else {
      document.getElementById('req-length').style.color = 'var(--text-secondary)';
    }

    // Check uppercase
    if (/[A-Z]/.test(password)) {
      score += 25;
      document.getElementById('req-upper').style.color = '#10b981';
    } else {
      document.getElementById('req-upper').style.color = 'var(--text-secondary)';
    }

    // Check lowercase
    if (/[a-z]/.test(password)) {
      score += 25;
      document.getElementById('req-lower').style.color = '#10b981';
    } else {
      document.getElementById('req-lower').style.color = 'var(--text-secondary)';
    }

    // Check number
    if (/[0-9]/.test(password)) {
      score += 25;
      document.getElementById('req-number').style.color = '#10b981';
    } else {
      document.getElementById('req-number').style.color = 'var(--text-secondary)';
    }

    // Update strength bar
    strengthFill.style.width = score + '%';

    if (score < 50) {
      strengthFill.style.background = '#ef4444';
      feedback = 'Weak password';
      strengthText.style.color = '#ef4444';
    } else if (score < 100) {
      strengthFill.style.background = '#f59e0b';
      feedback = 'Medium strength';
      strengthText.style.color = '#f59e0b';
    } else {
      strengthFill.style.background = '#10b981';
      feedback = 'Strong password';
      strengthText.style.color = '#10b981';
    }

    strengthText.textContent = password ? feedback : '';
    checkPasswordMatch();
  }

  function checkPasswordMatch() {
    const password = document.getElementById('regPassword').value;
    const confirm = document.getElementById('regPasswordConfirm').value;
    const matchText = document.getElementById('matchText');

    if (!confirm) {
      matchText.textContent = '';
      return;
    }

    if (password === confirm) {
      matchText.textContent = '✓ Passwords match';
      matchText.style.color = '#10b981';
    } else {
      matchText.textContent = '✗ Passwords do not match';
      matchText.style.color = '#ef4444';
    }
  }

  async function submitRegister(e) {
    e.preventDefault();
    const name = document.getElementById('regName').value.trim();
    const country = document.getElementById('regCountry').value;
    const email = document.getElementById('regEmail').value.trim();
    const momo_number = document.getElementById('regMomo').value.trim();
    const password = document.getElementById('regPassword').value;
    const password_confirmation = document.getElementById('regPasswordConfirm').value;
    const err = document.getElementById('regError');
    const btn = e.target.querySelector('button[type="submit"]');
    const originalBtnText = btn.innerHTML;

    // Client-side validation
    if (password !== password_confirmation) {
      err.textContent = 'Passwords do not match';
      err.style.display = 'block';
      return;
    }

    // Reset error
    err.style.display = 'none';
    err.textContent = '';
    err.style.background = 'rgba(239, 68, 68, 0.1)';
    err.style.borderColor = 'rgba(239, 68, 68, 0.3)';
    err.style.color = '#ef4444';

    // Set loading state
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin" style="width: 20px; height: 20px; margin-right: 8px; display: inline-block; vertical-align: middle;"></i> Creating Account...';
    if (window.lucide && lucide.createIcons) lucide.createIcons();

    try {
      const res = await fetch(`${API_URL}/vendors/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, country, email, momo_number, password, password_confirmation })
      });
      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.detail || 'Registration failed');
      }

      if (data.requires_verification) {
        // Show verification modal
        pendingEmail = data.email;
        document.getElementById('verifyEmailDisplay').textContent = pendingEmail;
        document.getElementById('verifyModal').style.display = 'flex';
        if (window.lucide && lucide.createIcons) lucide.createIcons();

        // Reset register button
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
        return;
      }

      // If no verification needed (fallback), auto-login
      // Update loading text for auto-login
      btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin" style="width: 20px; height: 20px; margin-right: 8px; display: inline-block; vertical-align: middle;"></i> Logging you in...';
      if (window.lucide && lucide.createIcons) lucide.createIcons();

      const loginRes = await fetch(`${API_URL}/vendors/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const loginData = await loginRes.json();

      if (!loginRes.ok || !loginData.success) {
        throw new Error(loginData.detail || 'Auto-login failed');
      }

      // Success feedback
      err.style.display = 'block';
      err.style.background = 'rgba(16, 185, 129, 0.1)';
      err.style.borderColor = 'rgba(16, 185, 129, 0.3)';
      err.style.color = '#10b981';
      err.textContent = 'Account created successfully! Redirecting...';

      localStorage.setItem('coinvibe_token', loginData.token);
      localStorage.setItem('coinvibe_user', JSON.stringify(loginData.vendor));

      setTimeout(() => {
        window.location.href = '/dashboard';
      }, 1000);

    } catch (errMsg) {
      err.textContent = errMsg.message || String(errMsg);
      err.style.display = 'block';
      // Reset button
      btn.disabled = false;
      btn.innerHTML = originalBtnText;
    }
  }

  async function submitVerification() {
    const code = document.getElementById('verifyCode').value.trim();
    const err = document.getElementById('verifyError');
    const btn = document.getElementById('verifyBtn');
    const originalText = btn.innerHTML;

    if (!code || code.length !== 6) {
      err.textContent = 'Please enter a valid 6-digit code';
      err.style.display = 'block';
      return;
    }

    err.style.display = 'none';
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin" style="width: 20px; height: 20px; margin-right: 8px; display: inline-block; vertical-align: middle;"></i> Verifying...';
    if (window.lucide && lucide.createIcons) lucide.createIcons();

    try {
      const res = await fetch(`${API_URL}/vendors/verify-email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: pendingEmail, code })
      });
      const data = await res.json();

      if (!res.ok || !data.success) {
        throw new Error(data.detail || 'Verification failed');
      }

      // Success
      btn.innerHTML = 'Verified! Redirecting...';
      btn.classList.remove('btn-success');
      btn.style.background = '#10b981';

      localStorage.setItem('coinvibe_token', data.token);
      localStorage.setItem('coinvibe_user', JSON.stringify(data.vendor));

      setTimeout(() => {
        window.location.href = '/dashboard';
      }, 1000);

    } catch (error) {
      err.textContent = error.message;
      err.style.display = 'block';
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }

  async function resendVerification() {
    const btn = document.getElementById('resendBtn');
    const originalText = btn.innerHTML;
    const err = document.getElementById('verifyError');

    btn.disabled = true;
    btn.innerHTML = 'Sending...';
    err.style.display = 'none';

    try {
      const res = await fetch(`${API_URL}/vendors/resend-verification`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: pendingEmail })
      });
      const data = await res.json();

      if (!res.ok || !data.success) {
        throw new Error(data.detail || 'Failed to resend code');
      }

      btn.innerHTML = '<span class="text-success">Code sent!</span>';
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }, 3000);

    } catch (error) {
      err.textContent = error.message;
      err.style.display = 'block';
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }

  // Initialize lucide icons on page load
  if (window.lucide) lucide.createIcons();
</script>
{% endblock %}